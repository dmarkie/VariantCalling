# About
- This pipeline is designed to take a collection of single-sample genomicVCF (g.vcf) files containing SNV and Indel calls, and produce a multisample VCF using a workflow that is largely consistent with GATK "best practise". It is designed for use on a SLURM cluster.

- The major outputs are a PrimaryCall VCF (standard multiallelic SNV and Indels calls for a cohort of individuals) and a SplitMultiallelic VCF, which splits multiallelic variants over two or more lines to represent them in a fashion that resembles "biallelic" variants. This format has some advantages for simplifying filtering commands. Note that individuals with sex chromosome aneusomies that have been processed to accurately represent ploidy, will be excluded from the Split VCF file as bcftools norm does not function for ploidy greater than two. These individuals will be present in the PrimaryCall VCF. 

- The script requires information about paths to certain resources and some other options, held in the file config.sh.

- Start the pipeline by running the Call_My_Variants.sh script. Once started this script will run interactively by requesting the full path to a directory into which the final files will be placed, the directory does not need to exist already. The name should be somewhat descriptive of the project or cohort and be unique eg "20191027_Genomic_GATK". 

If this is not a restart of a process that is partially completed it will then request:

- the g.vcf files to include in the form of a samplemap file, which should contain all individuals to be included in this call. The format is a two-column tab delimited file with sample IDs and full paths to the relevant g.vcf.gz file, one sample per line.

- a pedigree file (LINKAGE format) that includes an entry for all individuals in the cohort (but can include others as well). This family information is used for genotype refinement, and for producing the Mendelian Violation metrics for trios identified in the cohort.

- information regarding capture platform (if used) - the name of the capture platform should correspond to the basename of a bed file in the directory specified by the PLATFORMS variable in the config.sh file. The bed file should describe the intervals included as targets for the capture platform (ie the manufacturer's manifest).

- information about whether gender was used in same way to fix the ploidy of the sex chromosomes when undertaking the single sample call with HaplotypeCaller - this is required to determine how to handle the X chromosome during the genotype refinement process (it needs to be excluded if males are called as XY instead of XXYY) as CalculateGenotypePosteriors can not handle monosomic regions

If it is a restart, once it has determined the project name from the final directory entered, and recognise there is a project partially completed, it will pick up the remaining information required from the initial run and continue with the jobs that are yet to complete.

The script will then:
- Generate a "Gender Report" by scraping information for each individual from the coverage.sh file that is generated by the FastQ2VCF alignment pipeline. This file needs to be present in the same directory as the g.vcf file for each individual as identified in the sample map. The gender report will highlight any discrepancies between reported and calculated (by coverage) gender, and identify any samples processed as sex chromosome aneusomies, that need to be excluded from the splitmultiallelic jobs.
 
- set up slurm jobs with appropriate dependencies for:

# GenomeDBImport.sl
GenomeDB groups the individual sample data (for each contig)

# genotypegvcf.sl
Joint genotyping (for each contig) from the GenomeDB files.

# recalvcf.sl
VQSR Calculate Recalibration separately for SNP and INDEL, across the entire genome using all contig files. Will also produce the plots for SNP and INDEL recalibration, and the tranche histograms for SNP.

# applyrecal.sl
VQSR Apply Recalibration. Applies SNP recalibration first, then INDEL recalibration (for each contig)

# refinement.sl
Genotype Refinement (for each contig):
- Calculates genotype posteriors based on available pedigree information and population (currently using Gnomad genomes 2.1)
- Identifies possible de novo mutations using pedigree information when available loConf and hiConf (currently not working and disabled)
- Adds a low quality genotype annotation for genotypes with a GQ less than 20
For this part of the workflow, the True X region and the Y chromosome are generally excluded from the first two steps as they do not work with non-diploid regions. If the X and Y chromosomes were uniformly called as diploid (for both males and females), the answer to the question about using gender for the sex chromosome ploidy will be negative and the X and Y chromosomes will now be included in these steps.

# splitmultiallelic.sl
Split multiallelics (for each contig) - this splits multiallelic variants into a "biallelic" representation with one line for each ALT allele at a position. Because this currently will not work for ploidy > 2, any sex chromosome aneusomies are excluded from the cohort for this step - so they will be absent from the "SplitMultiallelics" vcf, but will still be present in the "PrimaryCall" vcf

# merge.sl
Merge contigs to produce a full vcf.gz file, containing multiallelic variant descriptions.

# mergesplit.sl
Merge contigs to produce a full vcf.gz file, containing Split "biallelic" variant descriptions.

# mendelviol.sl
Calculates Mendelian Violation stats for all trios in the cohort (according to the pedigree file)

# move.sl 
Transfers important files/directories from the working directory to the final estination, makes a tarball of this script directory for future reference, removes the majority of unnecessary files/directories from the working directory.

# clean.sl
Transfers some remaining files before tarballing the working directory (to include the slurm outputs files and the compressed script file) and sending to the final destination. Removes the working directory
